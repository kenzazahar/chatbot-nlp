<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Chatbot NLP</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .chart-card h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .conversations-table {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th, td {
            padding: 15px;
            text-align: left;
        }

        tbody tr:hover {
            background: #f5f5f5;
        }

        .intent-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .intent-salutation { background: #e3f2fd; color: #1976d2; }
        .intent-commande { background: #fff3e0; color: #f57c00; }
        .intent-livraison { background: #f3e5f5; color: #7b1fa2; }
        .intent-retour { background: #fce4ec; color: #c2185b; }
        .intent-unknown { background: #ffebee; color: #d32f2f; }

        .emotion-icon {
            font-size: 20px;
        }

        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 10px 5px;
            transition: transform 0.2s;
        }

        .export-btn:hover {
            transform: scale(1.05);
        }

        .filters {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .filter-input {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
        }

        .filter-input:focus {
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ“Š Dashboard Administrateur</h1>
            <p>Vue d'ensemble des performances du chatbot</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ’¬</div>
                <div class="stat-value" id="totalConv">0</div>
                <div class="stat-label">Conversations</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">ğŸ¯</div>
                <div class="stat-value" id="avgConfidence">0%</div>
                <div class="stat-label">Confiance Moyenne</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">ğŸ˜Š</div>
                <div class="stat-value" id="happyUsers">0</div>
                <div class="stat-label">Utilisateurs Satisfaits</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">âš¡</div>
                <div class="stat-value" id="todayConv">0</div>
                <div class="stat-label">Aujourd'hui</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <h3>ğŸ“ˆ Intentions les plus frÃ©quentes</h3>
                <canvas id="intentsChart"></canvas>
            </div>

            <div class="chart-card">
                <h3>ğŸ˜Š Distribution des Ã©motions</h3>
                <canvas id="emotionsChart"></canvas>
            </div>
        </div>

        <div class="chart-card" style="margin-bottom: 20px;">
            <h3>ğŸ“… Conversations par jour (7 derniers jours)</h3>
            <canvas id="timelineChart"></canvas>
        </div>

        <!-- Conversations Table -->
        <div class="conversations-table">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>ğŸ’¬ DerniÃ¨res Conversations</h3>
                <div>
                    <button class="export-btn" onclick="exportCSV()">ğŸ“¥ Export CSV</button>
                    <button class="export-btn" onclick="exportJSON()">ğŸ“¥ Export JSON</button>
                </div>
            </div>

            <div class="filters">
                <input type="text" class="filter-input" id="searchInput" placeholder="ğŸ” Rechercher...">
                <select class="filter-input" id="intentFilter">
                    <option value="">Toutes les intentions</option>
                </select>
                <select class="filter-input" id="emotionFilter">
                    <option value="">Toutes les Ã©motions</option>
                    <option value="happy">ğŸ˜Š Heureux</option>
                    <option value="neutral">ğŸ˜ Neutre</option>
                    <option value="frustrated">ğŸ˜¤ FrustrÃ©</option>
                </select>
            </div>

            <table id="conversationsTable">
                <thead>
                    <tr>
                        <th>ğŸ• Date</th>
                        <th>ğŸ’¬ Message</th>
                        <th>ğŸ¯ Intention</th>
                        <th>ğŸ˜Š Ã‰motion</th>
                        <th>ğŸ“Š Confiance</th>
                        <th>ğŸ’­ RÃ©ponse</th>
                    </tr>
                </thead>
                <tbody id="conversationsBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let allConversations = [];
        let charts = {};

        // Charger les donnÃ©es
        async function loadDashboard() {
            try {
                const response = await fetch('/api/admin/stats');
                const data = await response.json();
                
                updateStats(data);
                createCharts(data);
                loadConversations();
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // Mettre Ã  jour les stats
        function updateStats(data) {
            document.getElementById('totalConv').textContent = data.total_conversations;
            document.getElementById('avgConfidence').textContent = (data.avg_confidence * 100).toFixed(0) + '%';
            document.getElementById('happyUsers').textContent = data.happy_users || 0;
            document.getElementById('todayConv').textContent = data.today_conversations || 0;
        }

        // CrÃ©er les graphiques
        function createCharts(data) {
            // Graphique des intentions
            const ctxIntents = document.getElementById('intentsChart').getContext('2d');
            charts.intents = new Chart(ctxIntents, {
                type: 'doughnut',
                data: {
                    labels: data.top_intents.map(i => i.intent),
                    datasets: [{
                        data: data.top_intents.map(i => i.count),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Graphique des Ã©motions
            const ctxEmotions = document.getElementById('emotionsChart').getContext('2d');
            charts.emotions = new Chart(ctxEmotions, {
                type: 'pie',
                data: {
                    labels: ['Heureux', 'Neutre', 'FrustrÃ©'],
                    datasets: [{
                        data: [
                            data.emotions?.happy || 0,
                            data.emotions?.neutral || 0,
                            data.emotions?.frustrated || 0
                        ],
                        backgroundColor: ['#4caf50', '#2196f3', '#f44336']
                    }]
                }
            });

            // Timeline
            const ctxTimeline = document.getElementById('timelineChart').getContext('2d');
            charts.timeline = new Chart(ctxTimeline, {
                type: 'line',
                data: {
                    labels: data.timeline?.labels || [],
                    datasets: [{
                        label: 'Conversations',
                        data: data.timeline?.data || [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                }
            });
        }

        // Charger les conversations
        async function loadConversations() {
            try {
                const response = await fetch('/api/admin/conversations');
                allConversations = await response.json();
                displayConversations(allConversations);
                populateFilters();
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        // Afficher les conversations
        function displayConversations(conversations) {
            const tbody = document.getElementById('conversationsBody');
            tbody.innerHTML = conversations.map(conv => `
                <tr>
                    <td>${new Date(conv.timestamp).toLocaleString('fr-FR')}</td>
                    <td>${conv.user_message}</td>
                    <td><span class="intent-badge intent-${conv.intent}">${conv.intent}</span></td>
                    <td class="emotion-icon">${getEmotionIcon(conv.emotion)}</td>
                    <td>${(conv.confidence * 100).toFixed(0)}%</td>
                    <td>${conv.bot_response.substring(0, 50)}...</td>
                </tr>
            `).join('');
        }

        function getEmotionIcon(emotion) {
            const icons = {
                'happy': 'ğŸ˜Š',
                'neutral': 'ğŸ˜',
                'frustrated': 'ğŸ˜¤',
                'concerned': 'ğŸ˜Ÿ'
            };
            return icons[emotion] || 'ğŸ˜';
        }

        // Filtres
        function populateFilters() {
            const intents = [...new Set(allConversations.map(c => c.intent))];
            const intentFilter = document.getElementById('intentFilter');
            intentFilter.innerHTML = '<option value="">Toutes les intentions</option>' +
                intents.map(i => `<option value="${i}">${i}</option>`).join('');
        }

        // Export CSV
        function exportCSV() {
            const csv = [
                ['Date', 'Message', 'Intention', 'Ã‰motion', 'Confiance', 'RÃ©ponse'],
                ...allConversations.map(c => [
                    new Date(c.timestamp).toISOString(),
                    c.user_message,
                    c.intent,
                    c.emotion,
                    c.confidence,
                    c.bot_response
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'conversations_' + new Date().toISOString() + '.csv';
            a.click();
        }

        // Export JSON
        function exportJSON() {
            const json = JSON.stringify(allConversations, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'conversations_' + new Date().toISOString() + '.json';
            a.click();
        }

        // Recherche et filtres
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('intentFilter').addEventListener('change', applyFilters);
        document.getElementById('emotionFilter').addEventListener('change', applyFilters);

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const intent = document.getElementById('intentFilter').value;
            const emotion = document.getElementById('emotionFilter').value;

            const filtered = allConversations.filter(c => 
                (search === '' || c.user_message.toLowerCase().includes(search) || c.bot_response.toLowerCase().includes(search)) &&
                (intent === '' || c.intent === intent) &&
                (emotion === '' || c.emotion === emotion)
            );

            displayConversations(filtered);
        }

        // Charger au dÃ©marrage
        loadDashboard();
        
        // RafraÃ®chir toutes les 30 secondes
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>